name: Build

# This workflow builds multiple quickstart images as defined in the images json
# passed to the workflow across the architectures defined in the archs input.
#
# See the images.json file in the repo for how to define the JSON for a set of
# images.
#
# This workflow is intended to be called by third parties to build custom
# quickstart images. See the repository README for an example.

on:
  workflow_call:
    inputs:
      repo:
        description: "Quickstart repo where quickstart is hosted"
        type: "string"
        default: "stellar/quickstart"
      ref:
        description: "Quickstart ref to build should match workflow (sha, branch, tag)"
        type: "string"
        default: "main"
      images:
        description: "A custom image.json (a single image from the same format as images.json), if not provided the full images.json is run"
        type: "string"
        required: true
      archs:
        description: 'Architectures to build for as an array (e.g. ["amd64", "arm64"])'
        type: "string"
        required: true
      test:
        description: "Whether the image tests should run"
        type: "boolean"
        default: true
      cache_id:
        description: "A value insert into cache keys to namespace cache usage, or invalidate it by incrementing"
        type: "string"
        default: 6

env:
  artifact_retention_days_for_image: 7

jobs:

  complete:
    if: always()
    name: complete
    needs: [setup, build, test]
    runs-on: ubuntu-latest
    steps:
    - if: contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')
      run: exit 1

  setup:
    name: 1 setup
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.sha.outputs.sha }}
      tag-prefix: ${{ steps.tag-prefix.outputs.tag-prefix }}
    steps:
    - uses: actions/checkout@v2
      with:
        repository: ${{ inputs.repo }}
        ref: ${{ inputs.ref }}
    - name: Sha
      id: sha
      run: |
        echo "sha=$(git rev-parse HEAD)" | tee -a $GITHUB_OUTPUT

  build:
    name: 2 build
    needs: setup
    uses: ./.github/workflows/internal-build.yml
    with:
      repo: ${{ inputs.repo }}
      sha: ${{ needs.setup.outputs.sha }}
      images: ${{ inputs.images }}
      archs: ${{ inputs.archs }}

  test:
    if: inputs.test
    name: 3 test
    needs: [setup, build]
    uses: ./.github/workflows/internal-test.yml
    with:
      repo: ${{ inputs.repo }}
      sha: ${{ needs.setup.outputs.sha }}
      images: ${{ inputs.images }}
      archs: ${{ inputs.archs }}
