#!/usr/bin/env python3

import json
import subprocess
import sys

# Auto-update script for images.json
#
# Usage: ./.scripts/auto-update <image-tag> <stable|rc>
#
# For 'stable': uses GitHub's latest stable release
# For 'rc': uses the newest release (prerelease or stable)

def main():
    if len(sys.argv) != 3 or sys.argv[2] not in ('stable', 'rc'):
        print("Usage: auto-update <image-tag> <stable|rc>", file=sys.stderr)
        sys.exit(1)

    image_tag, mode = sys.argv[1], sys.argv[2]

    with open('images.json', 'r') as f:
        images = json.load(f)

    # Find target image
    target = next((img for img in images if img['tag'] == image_tag), None)
    if not target:
        print(f"Error: image '{image_tag}' not found", file=sys.stderr)
        sys.exit(1)

    updated = False
    for dep in target['deps']:
        name, repo, current = dep['name'], dep['repo'], dep['ref']

        # Skip non-release refs (branches, SHAs)
        if not current.startswith('v'):
            print(f"{name}: skipping, ref is not a version")
            continue

        latest = get_latest_release(repo, include_prerelease=(mode == 'rc'))
        if not latest:
            print(f"{name}: skipping, no release found")
        elif latest != current:
            print(f"{name}: {current} -> {latest}")
            dep['ref'] = latest
            updated = True
        else:
            print(f"{name}: matches latest release")

    if updated:
        with open('images.json', 'w') as f:
            json.dump(images, f, indent=2)
            f.write('\n')

def get_latest_release(repo, include_prerelease=False):
    """Get the latest release. If include_prerelease is False, skip prereleases."""
    for rel in get_releases(repo):
        if include_prerelease and 'rc' in rel['tag']:
            return rel['tag']
        if not rel['prerelease']:
            return rel['tag']
    return None

def get_releases(repo):
    """Get all releases from a repo."""
    result = subprocess.run(
        ['gh', 'api', f'repos/{repo}/releases', '--jq', '[.[] | {tag: .tag_name, prerelease: .prerelease}]'],
        capture_output=True, text=True
    )
    if result.returncode != 0:
        print(f"Error: failed to get releases for {repo}: {result.stderr}", file=sys.stderr)
        sys.exit(1)
    return json.loads(result.stdout)

if __name__ == '__main__':
    main()
