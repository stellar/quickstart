FROM node:22 AS builder

ARG REPO
ARG REF
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=8100
WORKDIR /lab
RUN git clone https://github.com/${REPO} /lab
RUN git fetch origin ${REF}
RUN git checkout ${REF}
RUN rm -rf .git
RUN corepack enable
RUN pnpm install --frozen-lockfile
ENV NEXT_PUBLIC_COMMIT_HASH=${REF}
ENV NEXT_PUBLIC_ENABLE_STANDALONE_OUTPUT=true
ENV NEXT_PUBLIC_ENABLE_EXPLORER=true
ENV NEXT_PUBLIC_DEFAULT_NETWORK=custom
ENV NEXT_PUBLIC_RESOURCE_PATH=/lab
ENV NEXT_BASE_PATH=/lab
RUN pnpm build

FROM scratch AS artifacts

COPY --from=builder /lab/build/standalone /lab
COPY --from=builder /lab/public /lab/public
COPY --from=builder /lab/build/static /lab/public/_next/static
COPY --from=builder /usr/local/bin/node /node
