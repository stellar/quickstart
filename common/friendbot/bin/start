#! /bin/bash

set -e
set -o pipefail

CONF=/opt/stellar/friendbot/etc/friendbot.cfg

# Wait for rpc to be ready if friendbot is configured to use it.
if grep -q rpc_url "$CONF"; then
  echo "Waiting for rpc to be available..."
  while ! (curl -sf -X POST -H 'Content-Type: application/json' -d '{"jsonrpc":"2.0","id":1,"method":"getHealth"}' http://localhost:8003 | jq --exit-status '.result.status == "healthy"' >/dev/null); do
    sleep 1
  done
fi

# Wait for horizon to be ready if friendbot is configured to use it.
if grep -q horizon_url "$CONF"; then
  echo "Waiting for horizon to be available..."
  while ! (curl -sf http://localhost:8001/ | jq --exit-status '.ingest_latest_ledger > 1' >/dev/null); do
    sleep 1
  done
fi

echo "starting friendbot..."
exec /usr/local/bin/friendbot --conf "$CONF"
